{
    "action": "update_file",
    "path": "api/excluded_contacts.php",
    "content": "<?php\n/* =====================================\n   CallCloud Admin - Excluded Contacts API\n   ===================================== */\n\nrequire_once '../config.php';\nrequire_once '../utils.php';\n\n// Set headers\nheader('Access-Control-Allow-Origin: ' . CORS_ALLOWED_ORIGINS);\nheader('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');\nheader('Access-Control-Allow-Headers: Authorization, Content-Type');\nheader('Content-Type: application/json');\n\nif ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\n    http_response_code(200);\n    exit;\n}\n\n// Require authentication\n$currentUser = Auth::requireAuth();\n$orgId = $currentUser['org_id'];\n\n// Get request data\n$data = json_decode(file_get_contents('php://input'), true);\n$method = $_SERVER['REQUEST_METHOD'];\n$id = $_GET['id'] ?? null;\n\nswitch ($method) {\n    \n    /* ===== GET ALL EXCLUDED CONTACTS ===== */\n    case 'GET':\n        $contacts = Database::select(\"\n            SELECT * FROM excluded_contacts \n            WHERE org_id = '$orgId' \n            ORDER BY created_at DESC\n        \");\n        \n        Response::success($contacts, 'Excluded contacts retrieved successfully');\n        break;\n    \n    /* ===== CREATE EXCLUDED CONTACT ===== */\n    case 'POST':\n        $action = $_GET['action'] ?? null;\n        \n        if ($action === 'delete_all_data') {\n            // Delete all data for ALL excluded contacts\n            $excluded = Database::select(\"SELECT phone FROM excluded_contacts WHERE org_id = '$orgId'\");\n            if (empty($excluded)) {\n                Response::success([], 'No excluded contacts to process');\n            }\n            \n            $phones = array_map(function($c) { return \"'\" . Database::escape($c['phone']) . \"'\"; }, $excluded);\n            $phoneList = implode(',', $phones);\n            \n            // Delete Physical Files\n            $recordings = Database::select(\"SELECT recording_url FROM calls WHERE caller_phone IN ($phoneList) AND org_id = '$orgId' AND recording_url IS NOT NULL AND recording_url != ''\");\n            foreach ($recordings as $rec) {\n                if ($rec['recording_url'] && file_exists($rec['recording_url'])) {\n                    @unlink($rec['recording_url']);\n                }\n            }\n            \n            // 1. Delete Calls\n            Database::execute(\"DELETE FROM calls WHERE caller_phone IN ($phoneList) AND org_id = '$orgId'\");\n            // 2. Delete Contact Info\n            Database::execute(\"DELETE FROM contacts WHERE phone IN ($phoneList) AND org_id = '$orgId'\");\n            \n            Response::success([], \\\"All related data for \\\" . count($excluded) . \\\" excluded contacts deleted\\\");\n        }\n\n        if ($action === 'delete_contact_data') {\n            Validator::required($data, ['phone']);\n            $phone = Database::escape($data['phone']);\n            \n            // Delete Physical Files\n            $recordings = Database::select(\"SELECT recording_url FROM calls WHERE caller_phone = '$phone' AND org_id = '$orgId' AND recording_url IS NOT NULL AND recording_url != ''\");\n            foreach ($recordings as $rec) {\n                if ($rec['recording_url'] && file_exists($rec['recording_url'])) {\n                    @unlink($rec['recording_url']);\n                }\n            }\n            \n            // 1. Delete Calls\n            Database::execute(\"DELETE FROM calls WHERE caller_phone = '$phone' AND org_id = '$orgId'\");\n            // 2. Delete Contact Info\n            Database::execute(\"DELETE FROM contacts WHERE phone = '$phone' AND org_id = '$orgId'\");\n            \n            Response::success([], 'Related data for this contact deleted');\n        }\n\n        Validator::required($data, ['phone']);\n        \n        $phone = Database::escape($data['phone']);\n        $name = isset($data['name']) ? Database::escape($data['name']) : '';\n        $isActive = isset($data['is_active']) ? (int)$data['is_active'] : 1;\n        \n        // Check if already exists\n        $existing = Database::getOne(\"SELECT id FROM excluded_contacts WHERE org_id = '$orgId' AND phone = '$phone'\");\n        if ($existing) {\n            Response::error('This contact is already excluded');\n        }\n        \n        $sql = \"INSERT INTO excluded_contacts (org_id, phone, name, is_active) \n                VALUES ('$orgId', '$phone', '$name', $isActive)\";\n        \n        $insertId = Database::insert($sql);\n        \n        if (!$insertId) {\n            Response::error('Failed to add excluded contact');\n        }\n        \n        $contact = Database::getOne(\"SELECT * FROM excluded_contacts WHERE id = $insertId\");\n        Response::success($contact, 'Contact excluded successfully');\n        break;\n    \n    /* ===== UPDATE EXCLUDED CONTACT ===== */\n    case 'PUT':\n        if (!$id) {\n            Response::error('ID required');\n        }\n        \n        // Check ownership\n        $contact = Database::getOne(\"SELECT id FROM excluded_contacts WHERE id = $id AND org_id = '$orgId'\");\n        if (!$contact) {\n            Response::error('Contact not found', 404);\n        }\n        \n        $updates = [];\n        if (isset($data['phone'])) $updates[] = \"phone = '\" . Database::escape($data['phone']) . \"'\";\n        if (isset($data['name'])) $updates[] = \"name = '\" . Database::escape($data['name']) . \"'\";\n        if (isset($data['is_active'])) $updates[] = \"is_active = \" . (int)$data['is_active'];\n        \n        if (empty($updates)) {\n            Response::error('No fields to update');\n        }\n        \n        $sql = \"UPDATE excluded_contacts SET \" . implode(', ', $updates) . \" WHERE id = $id\";\n        Database::execute($sql);\n        \n        $updated = Database::getOne(\"SELECT * FROM excluded_contacts WHERE id = $id\");\n        Response::success($updated, 'Excluded contact updated successfully');\n        break;\n    \n    /* ===== DELETE EXCLUDED CONTACT ===== */\n    case 'DELETE':\n        if (!$id) {\n            Response::error('ID required');\n        }\n        \n        // Check ownership\n        $contact = Database::getOne(\"SELECT id FROM excluded_contacts WHERE id = $id AND org_id = '$orgId'\");\n        if (!$contact) {\n            Response::error('Contact not found', 404);\n        }\n        \n        $sql = \"DELETE FROM excluded_contacts WHERE id = $id\";\n        Database::execute($sql);\n        \n        Response::success([], 'Excluded contact removed successfully');\n        break;\n    \n    default:\n        Response::error('Method not allowed', 405);\n}\n"
}