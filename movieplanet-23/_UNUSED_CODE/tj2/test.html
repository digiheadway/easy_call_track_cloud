<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Action</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXX-Y"></script>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 90vh;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        .glow-on-hover {
            width: 220px;
            height: 50px;
            border: none;
            outline: none;
            color: #fff;
            background: #111;
            cursor: pointer;
            position: relative;
            z-index: 0;
            border-radius: 10px;

        }

        .glow-on-hover:before {
            content: '';
            background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
            position: absolute;
            top: -2px;
            left: -2px;
            background-size: 400%;
            z-index: -1;
            filter: blur(5px);
            width: calc(100% + 4px);
            height: calc(100% + 4px);
            animation: glowing 20s linear infinite;
            opacity: 1;
            transition: opacity .3s ease-in-out;
            border-radius: 10px;
        }

        .glow-on-hover:active {
            color: #000
        }

        .glow-on-hover:active:after {
            background: transparent;
        }

        .glow-on-hover:hover:before {
            opacity: 1;
        }

        .glow-on-hover:after {
            z-index: -1;
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: #111;
            left: 0;
            top: 0;
            border-radius: 10px;
        }

        @keyframes glowing {
            0% {
                background-position: 0 0;
            }

            50% {
                background-position: 400% 0;
            }

            100% {
                background-position: 0 0;
            }
        }
    </style>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'UA-XXXXX-Y');  // Replace with your Google Analytics ID
    </script>
</head>

<body>
    <button id="action_btn" class="glow-on-hover">Download TeraBox</button>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            // Check if the 'tj2' key exists and is set to true in localStorage
            localStorage.setItem("tj2", "true");
            if (localStorage.getItem("tj2") !== "true") {
                return; // If 'tj2' is not true, stop execution
            }

            // Check if link_id is already in localStorage
            let link_id = localStorage.getItem("assigned_link_id_i");

            if (!link_id) {
                // Fetch the latest unused link ID from the server if not found in localStorage
                const response = await fetch("/tj2/fetch_link.php");
                const data = await response.json();

                if (data.success && data.link_id) {
                    link_id = data.link_id;
                    localStorage.setItem("assigned_link_id", link_id); // Store the fetched link_id in localStorage
                } else {
                    alert('No unused/unreserved link found in the database.');
                    console.log("No unused link found in the database.");
                    return;
                }
            }

            // Construct the market URL
            // const marketurl = `market://details?id=com.dubox.drive&referrer=utm_source=tera_sharelink&utm_campaign=header_button&surl=L2GEqKHfs9pzwGD9OQ3i0g&tera_link_id=${link_id}&tera_link_type=1&c=https://www.1024tera.com/wap/share/filelist?surl=L2GEqKHfs9pzwGD9OQ3i0g&af_dp=dubox://share_detail?shareid=58712493527&uk=4398511686747&share_create_time=1734217962&randsk=brxzEUa2yGI6EcWGDP7XmhzSzTmSpCxEVB1x%20viMXdU=&share_expired_time=0&source=af_link&share_file_count=1&surl=L2GEqKHfs9pzwGD9OQ3i0g&agency=j1__0`;
            const marketurl = "https://be6.in/open_tera";
            // Get the action button
            const actionButton = document.getElementById("action_btn");

            // Remove any existing onclick handlers by setting the inline onclick to null (if any)
            actionButton.onclick = null;  // Remove inline onclick attribute

            // Attach the new click event listener
            actionButton.addEventListener("click", async function () {
                try {
                    // Step 1: Mark the link as used in the database
                    const updateResponse = await fetch("/tj2/update_link.php", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ link_id })
                    });

                    const updateData = await updateResponse.json();
                    if (!updateData.success) {
                        throw new Error("Failed to update the link status in the database");
                    }

                    // Step 2: Copy "{link_id}&type=1" to clipboard
                    const textToCopy = `&surl=L2GEqKHfs9pzwGD9OQ3i0g&tera_link_id=${link_id}&tera_link_type=1`;
                    await navigator.clipboard.writeText(textToCopy);
                    console.log("Copied to clipboard:", textToCopy);

                    // Step 3: Open the market URL
                    window.open(marketurl, "_blank");

                    // Step 4: Push gtag event to Google Analytics
                    if (typeof gtag === "function") {
                        gtag("event", "button_click", {
                            event_category: "Action",
                            event_label: marketUrl
                        });
                    }
                } catch (err) {
                    console.error("Error in processing:", err);
                }
            });
        });

    </script>
</body>

</html>