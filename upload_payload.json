{"action": "update_file", "path": "api/calls.php", "content": "<?php\n/* =====================================\n   CallCloud Admin - Calls API\n   ===================================== */\n\nrequire_once '../config.php';\nrequire_once '../utils.php';\n\n// Set headers\nheader('Access-Control-Allow-Origin: ' . CORS_ALLOWED_ORIGINS);\nheader('Access-Control-Allow-Methods: GET, POST, PUT, OPTIONS');\nheader('Access-Control-Allow-Headers: Authorization, Content-Type');\nheader('Content-Type: application/json');\n\nif ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {\n    http_response_code(200);\n    exit;\n}\n\n// Require authentication\n$currentUser = Auth::requireAuth();\n$orgId = $currentUser['org_id'];\n\n// Get request data\n$data = json_decode(file_get_contents('php://input'), true);\n$method = $_SERVER['REQUEST_METHOD'];\n$action = $_GET['action'] ?? '';\n$id = $_GET['id'] ?? null;\n\nswitch ($method) {\n    \n    /* ===== GET CALLS ===== */\n    case 'GET':\n        if ($action === 'stats') {\n            // Get call statistics\n            $stats = Database::getOne(\"\n                SELECT \n                    COUNT(*) as total,\n                    SUM(CASE WHEN type = 'Incoming' THEN 1 ELSE 0 END) as inbound,\n                    SUM(CASE WHEN type = 'Outgoing' THEN 1 ELSE 0 END) as outbound,\n                    SUM(CASE WHEN duration = 0 THEN 1 ELSE 0 END) as missed,\n                    AVG(NULLIF(duration, 0)) as avg_duration\n                FROM calls \n                WHERE org_id = '$orgId'\n            \");\n            \n            // Format average duration back to MM:SS\n            $avg = $stats['avg_duration'] ?? 0;\n            $minutes = floor($avg / 60);\n            $seconds = $avg % 60;\n            $stats['avg_duration_formatted'] = sprintf('%d:%02d', $minutes, $seconds);\n            \n            Response::success($stats, 'Call statistics retrieved');\n        } else if ($action === 'debug_time') {\n            $res = Database::select(\"\n                SELECT \n                    id, \n                    call_time, \n                    UTC_TIMESTAMP() as db_utc_now,\n                    NOW() as db_now\n                FROM calls \n                ORDER BY call_time DESC \n                LIMIT 5\n            \");\n            Response::success([\n                'data' => $res,\n                'php_now' => date('Y-m-d H:i:s'),\n                'php_timezone' => date_default_timezone_get()\n            ]);\n        } else if ($action === 'list') {\n            $limit = isset($_GET['limit']) ? (int)$_GET['limit'] : 50;\n            $calls = Database::select(\"\n                SELECT \n                    c.*, \n                    c.caller_name as contact_name,\n                    c.caller_phone as phone_number,\n                    e.name as employee_name\n                FROM calls c\n                LEFT JOIN employees e ON c.employee_id = e.id\n                WHERE c.org_id = '$orgId'\n                ORDER BY c.call_time DESC\n                LIMIT $limit\n            \");\n            Response::success($calls, 'Recent calls retrieved');\n        } else {\n            // Get filters\n            $direction = $_GET['direction'] ?? ''; // Maps to type\n            $dateFilter = $_GET['dateRange'] ?? $_GET['dateFilter'] ?? 'all'; // Support dateRange param\n            $employeeId = $_GET['employeeId'] ?? ''; // Support employee filter\n            $reviewedFilter = $_GET['reviewed'] ?? ''; // Filter by reviewed status\n            \n            $search = $_GET['search'] ?? '';\n            $page = isset($_GET['page']) ? (int)$_GET['page'] : 1;\n            $limit = isset($_GET['limit']) ? (int)$_GET['limit'] : 20;\n            $offset = ($page - 1) * $limit;\n            \n            // Build query\n            $where = [\"c.org_id = '$orgId'\"];\n            \n            // Employee Filter\n            if ($employeeId && $employeeId !== 'all') {\n                $where[] = \"c.employee_id = \" . (int)$employeeId;\n            }\n            \n            if ($direction && $direction !== 'all') {\n                $dirMap = [\n                    'inbound' => 'Inbound',\n                    'outbound' => 'Outbound',\n                    'missed' => 'Missed' \n                ];\n                $dbType = $dirMap[$direction] ?? $direction;\n                if ($dbType === 'Inbound') {\n                    $where[] = \"(c.type = 'Inbound' OR c.type = 'Incoming')\";\n                } else if ($dbType === 'Outbound') {\n                    $where[] = \"(c.type = 'Outbound' OR c.type = 'Outgoing')\";\n                } else {\n                    $where[] = \"c.type = '\" . Database::escape($dbType) . \"'\";\n                }\n            }\n            \n            // Date Filter logic (aligned with Dashboard)\n            $timezoneOffset = isset($_GET['tzOffset']) ? (int)$_GET['tzOffset'] : 0; \n            $dbOffsetMinutes = -1 * $timezoneOffset;\n            $sqlLocalTime = \"DATE_ADD(c.call_time, INTERVAL $dbOffsetMinutes MINUTE)\";\n            $sqlLocalNow = \"DATE_ADD(UTC_TIMESTAMP(), INTERVAL $dbOffsetMinutes MINUTE)\";\n\n            switch ($dateFilter) {\n                case 'today':\n                    $where[] = \"DATE($sqlLocalTime) = DATE($sqlLocalNow)\";\n                    break;\n                case 'yesterday':\n                    $where[] = \"DATE($sqlLocalTime) = DATE(DATE_SUB($sqlLocalNow, INTERVAL 1 DAY))\";\n                    break;\n                case '3days':\n                   $where[] = \"$sqlLocalTime >= DATE_SUB($sqlLocalNow, INTERVAL 3 DAY)\";\n                   break;\n                case 'week': // Keeping for legacy support\n                case '7days':\n                    $where[] = \"$sqlLocalTime >= DATE_SUB($sqlLocalNow, INTERVAL 7 DAY)\";\n                    break;\n                case '14days':\n                    $where[] = \"$sqlLocalTime >= DATE_SUB($sqlLocalNow, INTERVAL 14 DAY)\";\n                    break;\n                case 'month':\n                case '30days':\n                    $where[] = \"$sqlLocalTime >= DATE_SUB($sqlLocalNow, INTERVAL 30 DAY)\";\n                    break;\n                case 'custom':\n                    // Expect startDate and endDate in YYYY-MM-DD\n                    if (isset($_GET['startDate']) && isset($_GET['endDate'])) {\n                        $s = Database::escape($_GET['startDate']);\n                        $e = Database::escape($_GET['endDate']);\n                        $where[] = \"DATE($sqlLocalTime) BETWEEN '$s' AND '$e'\";\n                    }\n                    break;\n            }\n            \n            // Reviewed Filter\n            if ($reviewedFilter !== '' && $reviewedFilter !== 'all') {\n                if ($reviewedFilter === 'reviewed') {\n                    $where[] = \"c.reviewed = 1\";\n                } else if ($reviewedFilter === 'unreviewed') {\n                    $where[] = \"(c.reviewed = 0 OR c.reviewed IS NULL)\";\n                }\n            }\n            \n            if ($search) {\n                $search = Database::escape($search);\n                $where[] = \"(c.caller_name LIKE '%$search%' OR c.caller_phone LIKE '%$search%')\";\n            }\n            \n            $whereClause = implode(' AND ', $where);\n            \n            // Get Total Count\n            $countResult = Database::getOne(\"SELECT COUNT(*) as total FROM calls c WHERE $whereClause\");\n            $total = $countResult['total'];\n            \n            // Get Data\n            $calls = Database::select(\"\n                SELECT \n                    c.*, \n                    c.id as id,\n                    c.labels,\n                    c.is_liked,\n                    c.caller_name as contact_name,\n                    c.caller_phone as phone_number,\n                    e.name as employee_name,\n                    c_info.notes as person_note\n                FROM calls c\n                LEFT JOIN employees e ON c.employee_id = e.id\n                LEFT JOIN (\n                    SELECT phone, org_id, notes \n                    FROM contacts \n                    GROUP BY phone, org_id\n                ) c_info ON (c.caller_phone = c_info.phone AND c.org_id = c_info.org_id)\n                WHERE $whereClause \n                ORDER BY c.call_time DESC\n                LIMIT $limit OFFSET $offset\n            \");\n            \n            Response::success([\n                'data' => $calls,\n                'pagination' => [\n                    'total' => (int)$total,\n                    'page' => $page,\n                    'limit' => $limit,\n                    'total_pages' => ceil($total / $limit)\n                ]\n            ], 'Calls retrieved successfully');\n        }\n        break;\n    \n    /* ===== CREATE OR UPDATE CALL LOG ===== */\n    case 'POST':\n    case 'PUT':\n        $isUpdate = ($method === 'PUT') || ($action === 'update');\n\n        if ($isUpdate) {\n            // --- UPDATE LOGIC ---\n            if (!$id) {\n                Response::error('Call ID required');\n            }\n\n            // Verify call belongs to Org\n            $call = Database::getOne(\"SELECT id, caller_phone, caller_name FROM calls WHERE id = $id AND org_id = '$orgId'\");\n            if (!$call) {\n                Response::error('Call not found', 404);\n            }\n\n            $updates = [];\n\n            // Allow updating Note\n            if (isset($data['note'])) {\n                $updates[] = \"note = '\" . Database::escape($data['note']) . \"'\";\n            }\n            \n            // Allow updating reviewed status\n            if (isset($data['reviewed'])) {\n                $reviewed = $data['reviewed'] ? 1 : 0;\n                $updates[] = \"reviewed = $reviewed\";\n            }\n            \n            // Allow updating is_liked\n            if (isset($data['is_liked'])) {\n                $liked = $data['is_liked'] ? 1 : 0;\n                $updates[] = \"is_liked = $liked\";\n            }\n\n            // Allow updating labels\n            if (isset($data['labels'])) {\n                // Determine if array or string\n                $lbls = $data['labels'];\n                if (is_array($lbls)) {\n                    $lbls = implode(',', $lbls);\n                }\n                $updates[] = \"labels = '\" . Database::escape($lbls) . \"'\";\n            }\n            \n            // Allow updating caller name\n            if (isset($data['contact_name'])) {\n                $updates[] = \"caller_name = '\" . Database::escape($data['contact_name']) . \"'\";\n            }\n            \n            // Allow updating recording\n            if (isset($data['recording_url'])) {\n                $updates[] = \"recording_url = '\" . Database::escape($data['recording_url']) . \"'\";\n            }\n            \n            // Update Person Note (in contacts table)\n            if (isset($data['person_note'])) {\n                $pNote = Database::escape($data['person_note']);\n                $phone = $call['caller_phone'];\n                \n                $contactExists = Database::getOne(\"SELECT id FROM contacts WHERE phone = '$phone' AND org_id = '$orgId'\");\n                if ($contactExists) {\n                    Database::execute(\"UPDATE contacts SET notes = '$pNote', updated_at = NOW() WHERE phone = '$phone' AND org_id = '$orgId'\");\n                } else {\n                    $pName = isset($data['contact_name']) ? Database::escape($data['contact_name']) : Database::escape($call['caller_name'] ?? 'Unknown');\n                    Database::insert(\"INSERT INTO contacts (org_id, phone, name, notes, created_at, updated_at) VALUES ('$orgId', '$phone', '$pName', '$pNote', NOW(), NOW())\");\n                }\n            }\n\n            if (!empty($updates)) {\n                $sql = \"UPDATE calls SET \" . implode(', ', $updates) . \" WHERE id = $id\";\n                Database::execute($sql);\n            }\n\n            $updatedCall = Database::getOne(\"\n                SELECT c.*, c_info.notes as person_note \n                FROM calls c \n                LEFT JOIN contacts c_info ON (c.caller_phone = c_info.phone AND c.org_id = c_info.org_id)\n                WHERE c.id = $id\n            \");\n            Response::success($updatedCall, 'Call updated successfully');\n        \n        } else {\n            // --- CREATE LOGIC ---\n            Validator::required($data, ['employee_id', 'phone_number', 'type']);\n            \n            $employeeId = (int)$data['employee_id'];\n            $callerName = Database::escape($data['contact_name'] ?? '');\n            $callerPhone = Database::escape($data['phone_number']);\n            $type = Database::escape($data['type']);\n            $duration = (int)($data['duration'] ?? 0);\n            $note = Database::escape($data['note'] ?? '');\n            $recordingUrl = Database::escape($data['recording_url'] ?? '');\n            $callTime = isset($data['call_time']) ? Database::escape($data['call_time']) : date('Y-m-d H:i:s');\n            \n            $employee = Database::getOne(\"SELECT id, name FROM employees WHERE id = $employeeId AND org_id = '$orgId'\");\n            if (!$employee) {\n                Response::error('Invalid employee ID');\n            }\n            \n            $sql = \"INSERT INTO calls (\n                        org_id, employee_id, caller_name, caller_phone, type, duration, call_time, note, recording_url\n                    ) VALUES (\n                        '$orgId', $employeeId, '$callerName', '$callerPhone', '$type', $duration, '$callTime', '$note', '$recordingUrl'\n                    )\";\n            \n            $callId = Database::insert($sql);\n            \n            if (!$callId) {\n                Response::error('Failed to create call log');\n            }\n            \n            Database::execute(\"UPDATE employees SET calls_today = calls_today + 1 WHERE id = $employeeId\");\n            $call = Database::getOne(\"SELECT * FROM calls WHERE id = $callId\");\n            \n            Response::success($call, 'Call logged successfully');\n        }\n        break;\n    \n    default:\n        Response::error('Method not allowed', 405);\n}\n"}